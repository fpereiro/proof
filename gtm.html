<html>
<head>
   <meta charset="utf8">
</head>
<body>
   <script src="https://cdn.jsdelivr.net/gh/fpereiro/gotob@50d142497e0a169c831de13b61bb839cca036c41/gotoB.min.js"></script>
   <script>
      (function () {

         // *** SETUP ***

         var dale = window.dale, teishi = window.teishi, lith = window.lith, c = window.c, B = window.B;
         var type = teishi.t, clog = console.log;

         B.prod = true;

         B.do ({from: {ev: 'initialize'}}, 'set', 'State', {});
         B.do ({from: {ev: 'initialize'}}, 'set', 'Data',  {});

         window.State = B.get ('State'), window.Data = B.get ('Data');

         c.ready (function () {
            B.mount ('body', Views.main ());
         });

         // *** MACHINES ***

         B.do ('set', ['Data', 'machines', 'Square root of 2'], {
            begin: {
               none: ['P@', 'R', 'P1', 'new']
            },
            new:   {
               '@':  ['R', 'mark-digits'],
               else: ['L', 'new'],
            },
            'mark-digits': {
               0:    ['R', 'Px', 'R',            'mark-digits'],
               1:    ['R', 'Px', 'R',            'mark-digits'],
               none: ['R', 'Pz', 'R', 'R', 'Pr', 'find-x'],
            },
            'find-x': {
               x:    ['E',      'first-r'],
               '@':  [          'find-digits'],
               else: ['L', 'L', 'find-x'],
            },
            'first-r': {
               r:    ['R', 'R', 'last-r'],
               else: ['R', 'R', 'first-r'],
            },
            'last-r': {
               r:    ['R', 'R',             'last-r'],
               none: ['Pr', 'R', 'R', 'Pr', 'find-x'],
            },
            'find-digits': {
               '@':  ['R', 'R', 'find-1st-digit'],
               else: ['L', 'L', 'find-digits'],
            },
            'find-1st-digit': {
               x:    ['L',      'found-1st-digit'],
               y:    ['L',      'found-1st-digit'],
               z:    ['L',      'found-2nd-digit'],
               none: ['R', 'R', 'find-1st-digit'],
            },
            'found-1st-digit': {
               0: ['R',           'add-zero'],
               1: ['R', 'R', 'R', 'find-2nd-digit'],
            },
            'find-2nd-digit': {
               x:    ['L',      'found-2nd-digit'],
               y:    ['L',      'found-2nd-digit'],
               none: ['R', 'R', 'find-2nd-digit'],
            },
            'found-2nd-digit': {
               0:    ['R', 'add-zero'],
               1:    ['R', 'add-one'],
               none: ['R', 'add-one'],
            },
            'add-zero': {
               r:    ['Ps',     'add-finished'],
               u:    ['Pv',     'add-finished'],
               else: ['R', 'R', 'add-zero'],
            },
            'add-one': {
               r:    ['Pv',           'add-finished'],
               u:    ['Ps', 'R', 'R', 'carry'],
               else: ['R', 'R',       'add-one'],
            },
            carry: {
               r:    ['Pu',           'add-finished'],
               none: ['Pu',           'new-digit-is-zero'],
               u:    ['Pr', 'R', 'R', 'carry'],
            },
            'add-finished': {
               '@':  ['R', 'R', 'erase-old-x'],
               else: ['L', 'L', 'add-finished'],
            },
            'erase-old-x': {
               x:    ['E',  'L', 'L', 'print-new-x'],
               z:    ['Py', 'L', 'L', 'print-new-x'],
               else: ['R', 'R',       'erase-old-x']
            },
            'print-new-x': {
               '@':  ['R', 'R', 'erase-old-y'],
               y:    ['Pz',     'find-digits'],
               none: ['Px',     'find-digits'],
            },
            'erase-old-y': {
               y:    ['E', 'L', 'L', 'print-new-y'],
               else: ['R', 'R',      'erase-old-y'],
            },
            'print-new-y': {
               '@':  ['R',       'new-digit-is-one'],
               else: ['Py', 'R', 'reset-new-x'],
            },
            'reset-new-x': {
               none: ['R', 'Px', 'flag-result-digits'],
               else: ['R', 'R',  'reset-new-x'],
            },
            'flag-result-digits': {
               s:    ['Pt', 'R', 'R', 'unflag-result-digits'],
               v:    ['Pw', 'R', 'R', 'unflag-result-digits'],
               else: ['R', 'R',       'flag-result-digits'],
            },
            'unflag-result-digits': {
               s:    ['Pr', 'R', 'R', 'unflag-result-digits'],
               v:    ['Pu', 'R', 'R', 'unflag-result-digits'],
               else: ['find-digits'],
            },
            'new-digit-is-zero': {
               '@':  ['R', 'print-zero-digit'],
               else: ['L', 'new-digit-is-zero'],
            },
            'print-zero-digit': {
               0:    ['R', 'E', 'R',       'print-zero-digit'],
               1:    ['R', 'E', 'R',       'print-zero-digit'],
               none: ['P0', 'R', 'R', 'R', 'cleanup'],
            },
            'new-digit-is-one': {
               '@':  ['R', 'print-one-digit'],
               else: ['L', 'new-digit-is-one'],
            },
            'print-one-digit': {
               0:    ['R', 'E', 'R',       'print-one-digit'],
               1:    ['R', 'E', 'R',       'print-one-digit'],
               none: ['P1', 'R', 'R', 'R', 'cleanup'],
            },
            cleanup: {
               none: [               'new'],
               else: ['E', 'R', 'R', 'cleanup'],
            }
         });

         // *** STYLES ***

         var CSS = {
            colors: ['blue', 'green', 'purple', 'teal'],
            pick: function (k) {
               return CSS.colors [k % CSS.colors.length];
            },
         };

         var style = function (a, b) {
            var output = arguments.length === 2 ? arguments [0] : {};
            output.style = '';
            dale.do (arguments [arguments.length - 1], function (v, k) {
               if (! v && v !== 0) return;
               var typeV = type (v);
               if (typeV === 'integer' && (v < 0 || v > 1)) v += 'px';
               if (typeV === 'float' || v === 1) v = (v * 100) + '%';
               dale.do (k.split (/,\s*/), function (v2) {
                  output.style += v2 + ':' + v + ';';
               });
            });
            return output;
         }

         // *** VIEWS ***

         var Views = {};

         Views.main = function () {
            var routes = [
               ['change', ['State', 'machine'], function (x) {
                  B.do ('set', ['State', 'tape'], []);
                  B.do ('set', ['State', 'config'],   'begin');
                  B.do ('set', ['State', 'position'], 1);
                  B.do ('pick', 'actions');
               }],
               ['pick', 'actions', function () {
                  var machine = Data.machines [State.machine];
                  var cconfig = machine [State.config];
                  var ctape   = teishi.c (State.tape [State.position]);
                  if (ctape === undefined) ctape = 'none';
                  var match = cconfig [ctape];
                  if (! match) match = cconfig ['else'];
                  if (! match) return alert ('Error: no available action!');
                  B.do ('set', ['State', 'actions'], match.slice (0, -1));
                  B.do ('set', ['State', 'next'], match [match.length - 1]);
               }],
               ['execute', [], function () {
                  dale.do (State.actions, function (action) {
                     if (action.match ('P')) return B.do ('set', ['State', 'tape', State.position], action.slice (1));
                     if (action.match ('L')) return B.do ('set', ['State', 'position'], State.position - 1);
                     if (action.match ('R')) return B.do ('set', ['State', 'position'], State.position + 1);
                     if (action === 'E')     return B.do ('set', ['State', 'tape', State.position], undefined);
                  });
                  B.do ('set', ['State', 'config'], State.next);
                  B.do ('pick', 'actions');
               }],
            ];
            return B.view ([], {listen: routes}, function (x, s) {
               return [
                  ['h1', 'Web Turing Machine'],
                  ['style', [
                     ['.action', {cursor: 'pointer', color: 'blue', 'text-decoration': 'underline'}],
                  ]],
                  B.view (['State', 'machine'], function (x, name) {
                     if (! name) return [
                        ['h3', 'List of machines'],
                        ['ul', dale.do (B.get ('Data', 'machines'), function (v, k) {
                           return ['li', B.ev ({class: 'action'}, ['onclick', 'set', ['State', 'machine'], k]), k];
                        })],
                     ];
                     var machine = B.get ('Data', 'machines', name);
                     var configs = dale.keys (machine);
                     return [
                        ['div', style ({width: 0.5, float: 'left'}), [
                           ['h3', [name, ['span', ' '], ['span', B.ev ({class: 'action'}, ['onclick', 'rem', 'State', 'machine']), 'Go back']]],
                           ['table', [
                              ['thead', [
                                 ['tr', [
                                    ['th', 'Config name'],
                                    ['th', 'Scanned symbol'],
                                    ['th', 'Operations'],
                                    ['th', 'Next config'],
                                 ]],
                              ]],
                              dale.do (machine, function (config, configname) {
                                 var c = 0;
                                 return dale.do (config, function (sequence, symbol) {
                                    c++;
                                    return ['tr', [
                                       ['td', style ({color: CSS.pick (configs.indexOf (configname))}), ['strong', c === 1 ? configname : '']],
                                       ['td', symbol],
                                       ['td', sequence.slice (0, -1).join (' ')],
                                       ['td', style ({color: CSS.pick (configs.indexOf (sequence [sequence.length - 1]))}), sequence [sequence.length - 1]],
                                    ]];
                                 });
                              }),
                           ]],
                        ]],
                        ['div', style ({width: 0.5, float: 'left'}), [
                           ['h2', 'Tape'],
                           ['p', 'Config: ' + B.get ('State', 'config')],
                           ['p', 'Position: ' + B.get ('State', 'position')],
                           ['p', 'Scanned symbol: ' + (function () {
                              var symbol = B.get ('State', 'tape', B.get ('State', 'position'));
                              return symbol === undefined ? 'none' : '';
                           }) ()],
                           ['p', ['Actions to perform: ' + (State.actions || []).join (' ')]],
                           ['p', 'Next config: ' + State.next],
                           ['p', B.ev ({class: 'action'}, ['onclick', 'execute', []]), 'Execute!'],
                           ['style', ['td.selected', {color: 'white', 'background-color': 'black', border: 'solid 1px red !important', 'font-weight': 'bold'}]],
                           ['table', dale.do (dale.times (20), function (v, k) {
                              return ['tr', dale.do (dale.times (20), function (v2, k2) {
                                 var position = k * 20 + k2 + 1;
                                 return ['td', style (position === B.get ('State', 'position') ? {class: 'selected'} : {}, {padding: 12, border: 'solid 1px black', 'max-width': 50, 'max-height': 50}), B.get ('State', 'tape', position)];
                              })];
                           })],
                        ]],
                     ];
                  }),
               ];
            });
         }

      }) ();
   </script>
</body>
</html>
